#include "parallax.h"
#include "mbed.h"
#include <math.h>      
#define PI 3.14159265

// extern parallax_servo *servo0_ptr, *servo1_ptr;
// extern Ticker servo_ticker;
// extern Ticker encoder_ticker;
// extern parallax_encoder *encoder3_ptr;
// extern Serial xbee;
// extern Serial pc;
extern car_x, car_y, car_theta;

float readEncoder() {
    return (float)(*encoder3_ptr);
}
void ServoStop(){
    servo0_ptr->set_speed(0);
    servo1_ptr->set_speed(0);
    servo0_ptr->set_factor(1);
    servo1_ptr->set_factor(1);
    return;
}
void ServoCtrl( int speed ){
    pc.printf("jjjj");
    servo0_ptr->set_speed(speed*0.3);
    servo1_ptr->set_speed(-speed*0.7);
    return;
}




void ServoDistaqnce(float distance) 
{
    ServoCtrl(90);
    while(encoder3_ptr->get_cm() < distance) wait_ms(50);
    ServoStop();
}
void ServoTurn(float deg){
    int speed = 50;
    if (deg < 0) { speed = -speed; deg = -deg;}
    servo0_ptr->set_speed(speed*0.3);
    servo1_ptr->set_speed(speed*0.7);
    while(encoder3_ptr->get_cm() < deg * 35 / 360) wait_ms(50);
    ServoStop();
}

void PointToPoint(float x, float y) {
    float deltax = x - car_x, deltay = y - car_y;
    float target = atan (deltay/deltax) * 180.0 / PI; 
    float turnDeg = target - car_theta;
    float distance = sqrt(pow(deltax, 2.0)+pow(deltay,2.0)); 
    ServoTurn(turnDeg);
    ServoDistaqnce(distance);
    car_x = x;
    car_y = y;
    car_theta = target;
}

void default_sketch1() {

}

/*



void reply_messange(char *xbee_reply, char *messange){
   xbee_reply[0] = xbee.getc();
   xbee_reply[1] = xbee.getc();
   xbee_reply[2] = xbee.getc();
   if(xbee_reply[1] == 'O' && xbee_reply[2] == 'K'){
    pc.printf("%s\r\n", messange);
    xbee_reply[0] = '\0';
    xbee_reply[1] = '\0';
    xbee_reply[2] = '\0';
   }
 }
 
 void check_addr(char *xbee_reply, char *messenger){
   xbee_reply[0] = xbee.getc();
   xbee_reply[1] = xbee.getc();
   xbee_reply[2] = xbee.getc();
   pc.printf("%s = %c%c\r\n", messenger, xbee_reply[1], xbee_reply[2]);
   xbee_reply[0] = '\0';
   xbee_reply[1] = '\0';
   xbee_reply[2] = '\0';
 }

 void xbeeConnect() 
 {
   
    pc.baud(9600);

    char xbee_reply[3];

    // XBee setting
    xbee.baud(9600);
    xbee.printf("+++");
    xbee_reply[0] = xbee.getc();
    xbee_reply[1] = xbee.getc();
    if(xbee_reply[0] == 'O' && xbee_reply[1] == 'K'){
        pc.printf("enter AT mode.\r\n");
        xbee_reply[0] = '\0';
        xbee_reply[1] = '\0';
    }
    xbee.printf("ATMY 0x60\r\n");
    reply_messange(xbee_reply, "setting MY : 0x60");

    xbee.printf("ATDL 0x61\r\n");
    reply_messange(xbee_reply, "setting DL : 0x62");

    xbee.printf("ATWR\r\n");
    reply_messange(xbee_reply, "write config");

    xbee.printf("ATMY\r\n");
    check_addr(xbee_reply, "MY");

    xbee.printf("ATDL\r\n");
    check_addr(xbee_reply, "DL");

    xbee.printf("ATCN\r\n");
    reply_messange(xbee_reply, "exit AT mode");
    xbee.getc();

    // start
    pc.printf("start\r\n");
    char buf[100] = {0};

}*/